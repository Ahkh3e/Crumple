{% extends "base.html" %}

{% block head %}
<style>
    #workboard {
        display: flex;
        height: calc(100vh - 150px);
    }
    
    #sidebar {
        width: 300px;
        padding: 15px;
        background-color: #f8f9fa;
        border-right: 1px solid #dee2e6;
        overflow-y: auto;
    }
    
    #cy {
        flex-grow: 1;
        height: 100%;
    }
    
    .device-info {
        margin-bottom: 15px;
        padding: 10px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
    }
    
    .interface-list {
        max-height: 200px;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<div id="workboard">
    <!-- Sidebar -->
    <div id="sidebar">
        <div class="mb-3">
            <label for="clusterSelect" class="form-label">Select Cluster</label>
            <select id="clusterSelect" class="form-select">
                <option value="">Choose a cluster...</option>
                {% for cluster in clusters %}
                <option value="{{ cluster.id }}">{{ cluster.name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="mb-3">
            <button id="syncClusterBtn" class="btn btn-primary" disabled>
                <i class="bi bi-arrow-repeat"></i> Sync Cluster
            </button>
            <button id="exportBtn" class="btn btn-secondary" disabled>
                <i class="bi bi-download"></i> Export
            </button>
        </div>
        
        <div class="mb-3">
            <h5>Layout</h5>
            <select id="layoutSelect" class="form-select">
                <option value="grid">Grid</option>
                <option value="circle">Circle</option>
                <option value="concentric">Concentric</option>
                <option value="breadthfirst">Breadth First</option>
                <option value="cose">CoSE</option>
            </select>
        </div>
        
        <div id="deviceInfo" class="device-info" style="display: none;">
            <h5>Device Information</h5>
            <div id="deviceDetails"></div>
        </div>
    </div>
    
    <!-- Cytoscape Container -->
    <div id="cy"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
let cy = null;
let selectedClusterId = null;
let selectedDeviceId = null;

// Initialize Cytoscape
function initCytoscape(elements) {
    if (cy) {
        cy.destroy();
    }
    
    cy = cytoscape({
        container: document.getElementById('cy'),
        elements: elements,
        style: [
            {
                selector: 'node',
                style: {
                    'label': 'data(label)',
                    'text-valign': 'center',
                    'text-halign': 'center',
                    'background-color': '#666',
                    'width': 60,
                    'height': 60
                }
            },
            {
                selector: 'edge',
                style: {
                    'label': function(ele) {
                        return `${ele.data('sourceInterface')} â†’ ${ele.data('targetInterface')}`;
                    },
                    'curve-style': 'bezier',
                    'target-arrow-shape': 'triangle',
                    'line-color': '#999',
                    'target-arrow-color': '#999',
                    'text-rotation': 'autorotate'
                }
            },
            {
                selector: ':selected',
                style: {
                    'background-color': '#337ab7',
                    'line-color': '#337ab7',
                    'target-arrow-color': '#337ab7'
                }
            }
        ],
        layout: {
            name: 'grid'
        }
    });
    
    // Node selection event
    cy.on('tap', 'node', function(evt) {
        const node = evt.target;
        selectedDeviceId = node.id();
        showDeviceInfo(node.data());
    });
    
    // Click on background to deselect
    cy.on('tap', function(evt) {
        if (evt.target === cy) {
            selectedDeviceId = null;
            hideDeviceInfo();
        }
    });
}

// Load cluster data
function loadCluster(clusterId) {
    selectedClusterId = clusterId;
    $('#syncClusterBtn, #exportBtn').prop('disabled', !clusterId);
    
    if (!clusterId) {
        if (cy) {
            cy.destroy();
            cy = null;
        }
        return;
    }
    
    $.get(`/api/clusters/${clusterId}`)
        .done(function(data) {
            initCytoscape(data.elements);
            applyLayout($('#layoutSelect').val());
        });
}

// Show device information in sidebar
function showDeviceInfo(deviceData) {
    const interfaces = Object.entries(deviceData.interfaces || {})
        .map(([name, info]) => `
            <div class="interface-item">
                <strong>${name}</strong>
                <div class="text-muted small">
                    Type: ${info.type || 'N/A'}<br>
                    Status: ${info.enabled ? 'Enabled' : 'Disabled'}
                </div>
            </div>
        `).join('');
    
    $('#deviceDetails').html(`
        <div class="mb-2">
            <strong>Name:</strong> ${deviceData.label}
        </div>
        <div class="mb-2">
            <strong>Type:</strong> ${deviceData.type || 'N/A'}
        </div>
        <div class="mb-2">
            <strong>Interfaces:</strong>
            <div class="interface-list">
                ${interfaces}
            </div>
        </div>
    `);
    
    $('#deviceInfo').show();
}

function hideDeviceInfo() {
    $('#deviceInfo').hide();
}

// Apply layout
function applyLayout(name) {
    if (!cy) return;
    
    const layouts = {
        'grid': {
            name: 'grid',
            padding: 50
        },
        'circle': {
            name: 'circle',
            padding: 50
        },
        'concentric': {
            name: 'concentric',
            minNodeSpacing: 50
        },
        'breadthfirst': {
            name: 'breadthfirst',
            padding: 50
        },
        'cose': {
            name: 'cose',
            padding: 50
        }
    };
    
    cy.layout(layouts[name]).run();
}

// Save layout
function saveLayout() {
    if (!selectedClusterId || !cy) return;
    
    const positions = {};
    cy.nodes().forEach(node => {
        positions[node.id()] = node.position();
    });
    
    $.ajax({
        url: `/api/clusters/${selectedClusterId}/layout`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(positions)
    }).done(function() {
        showAlert('success', 'Layout saved');
    });
}

// Event handlers
$('#clusterSelect').change(function() {
    loadCluster($(this).val());
});

$('#layoutSelect').change(function() {
    applyLayout($(this).val());
});

$('#syncClusterBtn').click(function() {
    if (!selectedClusterId) return;
    
    $.post(`/api/clusters/${selectedClusterId}/sync`)
        .done(function() {
            showAlert('success', 'Cluster sync scheduled');
        });
});

$('#exportBtn').click(function() {
    if (!selectedClusterId) return;
    window.location.href = `/api/clusters/${selectedClusterId}/export`;
});

// Auto-save layout when nodes are moved
let layoutTimeout;
cy?.on('position', 'node', function() {
    clearTimeout(layoutTimeout);
    layoutTimeout = setTimeout(saveLayout, 1000);
});
</script>
{% endblock %}
