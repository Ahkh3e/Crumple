{% extends "base.html" %}

{% block head %}
<style>
    #workboard {
        display: flex;
        height: 100vh;
    }
    
    #sidebar {
        width: 200px;
        background-color: #f8f9fa;
        overflow-y: auto;
        border-right: 1px solid #dee2e6;
    }
    
    #cy {
        flex-grow: 1;
        height: 100%;
    }
    
    .sidebar-section {
        padding: 8px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .sidebar-section h5 {
        color: #495057;
        font-size: 0.8rem;
        margin: 0;
        padding: 4px 8px;
        white-space: nowrap;
    }
    
    .search-input {
        width: 100%;
        padding: 6px 8px;
        margin: 4px 0;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        font-size: 0.9rem;
        background-color: white;
    }
    
    .search-input:focus {
        outline: none;
        border-color: #0d6efd;
        box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);
    }
    
    .cluster-btn {
        width: 100%;
        padding: 8px 12px;
        margin: 2px 0;
        background: transparent;
        border: none;
        color: #495057;
        text-align: left;
        white-space: nowrap;
        transition: all 0.2s ease;
        border-radius: 4px;
        display: flex;
        align-items: center;
        font-size: 0.9rem;
    }
    
    .cluster-btn:before {
        content: "⬤";
        margin-right: 8px;
        font-size: 0.7em;
        color: #adb5bd;
    }
    
    .cluster-btn:hover {
        background-color: #e9ecef;
    }
    
    .cluster-btn.active {
        background-color: #0d6efd;
        color: white;
    }
    
    .cluster-btn.active:before {
        color: white;
    }
    
    .layout-select {
        width: 100%;
        padding: 6px 8px;
        background-color: white;
        color: #495057;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        margin-top: 4px;
        font-size: 0.9rem;
    }
    
    .layout-select:focus {
        outline: none;
        border-color: #0d6efd;
        box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);
    }
    
    .device-info {
        color: #495057;
        padding: 8px;
        display: none;
    }
    
    .device-info h5 {
        color: #495057;
        font-size: 0.8rem;
        margin: 0 0 8px 0;
    }
    
    .interface-list {
        max-height: 300px;
        overflow-y: auto;
        font-size: 0.9rem;
    }
    
    .interface-item {
        padding: 6px 8px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .interface-item:last-child {
        border-bottom: none;
    }
    
    .text-muted {
        color: #6c757d !important;
    }

    /* Scrollbar styling */
    #sidebar::-webkit-scrollbar {
        width: 6px;
    }
    
    #sidebar::-webkit-scrollbar-track {
        background: #f8f9fa;
    }
    
    #sidebar::-webkit-scrollbar-thumb {
        background: #dee2e6;
        border-radius: 3px;
    }
    
    #sidebar::-webkit-scrollbar-thumb:hover {
        background: #adb5bd;
    }
</style>
{% endblock %}

{% block content %}
<div id="workboard">
    <!-- Sidebar -->
    <div id="sidebar">
        <div class="sidebar-section">
            <h5>Clusters</h5>
            <input type="text" class="search-input" placeholder="Search clusters..." id="clusterSearch">
            <div id="clusterButtons">
                {% for cluster in clusters %}
                <button class="cluster-btn" data-cluster-id="{{ cluster.id }}">
                    {{ cluster.name }}
                </button>
                {% endfor %}
            </div>
        </div>
        
        <div class="sidebar-section">
            <h5>Layout</h5>
            <select id="layoutSelect" class="layout-select">
                <option value="grid">Grid</option>
                <option value="circle">Circle</option>
                <option value="concentric">Concentric</option>
                <option value="breadthfirst">Breadth First</option>
                <option value="cose">CoSE</option>
            </select>
        </div>
        
        <div id="deviceInfo" class="device-info">
            <h5>Device Information</h5>
            <div id="deviceDetails"></div>
        </div>
    </div>
    
    <!-- Cytoscape Container -->
    <div id="cy"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
let cy = null;
let selectedClusterId = null;
let selectedDeviceId = null;

// Initialize Cytoscape
function initCytoscape(elements) {
    if (cy) {
        cy.destroy();
    }
    
    cy = cytoscape({
        container: document.getElementById('cy'),
        elements: elements,
        style: [
            {
                selector: 'node',
                style: {
                    'label': 'data(label)',
                    'text-valign': 'center',
                    'text-halign': 'center',
                    'background-color': '#666',
                    'width': 60,
                    'height': 60
                }
            },
            {
                selector: 'edge',
                style: {
                    'label': function(ele) {
                        return `${ele.data('sourceInterface')} → ${ele.data('targetInterface')}`;
                    },
                    'curve-style': 'bezier',
                    'target-arrow-shape': 'triangle',
                    'line-color': '#999',
                    'target-arrow-color': '#999',
                    'text-rotation': 'autorotate'
                }
            },
            {
                selector: ':selected',
                style: {
                    'background-color': '#337ab7',
                    'line-color': '#337ab7',
                    'target-arrow-color': '#337ab7'
                }
            }
        ],
        layout: {
            name: 'grid'
        }
    });
    
    // Node selection event
    cy.on('tap', 'node', function(evt) {
        const node = evt.target;
        selectedDeviceId = node.id();
        showDeviceInfo(node.data());
    });
    
    // Click on background to deselect
    cy.on('tap', function(evt) {
        if (evt.target === cy) {
            selectedDeviceId = null;
            hideDeviceInfo();
        }
    });
}

// Load cluster data
function loadCluster(clusterId) {
    selectedClusterId = clusterId;
    
    if (!clusterId) {
        if (cy) {
            cy.destroy();
            cy = null;
        }
        return;
    }
    
    $.get(`/api/clusters/${clusterId}`)
        .done(function(data) {
            initCytoscape(data.elements);
            applyLayout($('#layoutSelect').val());
        });
}

// Show device information in sidebar
function showDeviceInfo(deviceData) {
    const interfaces = Object.entries(deviceData.interfaces || {})
        .map(([name, info]) => `
            <div class="interface-item">
                <strong>${name}</strong>
                <div class="text-muted small">
                    Type: ${info.type || 'N/A'}<br>
                    Status: ${info.enabled ? 'Enabled' : 'Disabled'}
                </div>
            </div>
        `).join('');
    
    $('#deviceDetails').html(`
        <div class="mb-2">
            <strong>${deviceData.label}</strong>
        </div>
        <div class="mb-2 text-muted">
            ${deviceData.type || 'N/A'}
        </div>
        <div class="interface-list">
            ${interfaces}
        </div>
    `);
    
    $('#deviceInfo').show();
}

function hideDeviceInfo() {
    $('#deviceInfo').hide();
}

// Apply layout
function applyLayout(name) {
    if (!cy) return;
    
    const layouts = {
        'grid': {
            name: 'grid',
            padding: 50
        },
        'circle': {
            name: 'circle',
            padding: 50
        },
        'concentric': {
            name: 'concentric',
            minNodeSpacing: 50
        },
        'breadthfirst': {
            name: 'breadthfirst',
            padding: 50
        },
        'cose': {
            name: 'cose',
            padding: 50
        }
    };
    
    cy.layout(layouts[name]).run();
}

// Save layout
function saveLayout() {
    if (!selectedClusterId || !cy) return;
    
    const positions = {};
    cy.nodes().forEach(node => {
        positions[node.id()] = node.position();
    });
    
    $.ajax({
        url: `/api/clusters/${selectedClusterId}/layout`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(positions)
    }).done(function() {
        showAlert('success', 'Layout saved');
    });
}

// Event handlers
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('clusterSearch');
    if (!searchInput) {
        console.error('Search input not found');
        return;
    }

    // Filter clusters
    function filterClusters() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        console.log('Filtering with term:', searchTerm);
        
        // Get fresh list of buttons each time
        const clusterButtons = document.getElementById('clusterButtons');
        if (!clusterButtons) {
            console.error('Cluster buttons container not found');
            return;
        }

        const buttons = clusterButtons.getElementsByClassName('cluster-btn');
        console.log('Found buttons:', buttons.length);

        Array.from(buttons).forEach(button => {
            const clusterName = button.textContent.toLowerCase().trim();
            console.log('Button text:', clusterName);
            button.style.display = clusterName.includes(searchTerm) ? 'flex' : 'none';
        });
    }

    // Add input event listener
    searchInput.addEventListener('input', filterClusters);
    
    // Initial filter in case there's a value
    filterClusters();

    // Cluster button clicks
    document.getElementById('clusterButtons').addEventListener('click', function(e) {
        if (e.target.classList.contains('cluster-btn')) {
            const clusterId = e.target.dataset.clusterId;
            document.querySelectorAll('.cluster-btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            loadCluster(clusterId);
        }
    });

    // Layout changes
    document.getElementById('layoutSelect').addEventListener('change', function() {
        applyLayout(this.value);
    });
});

// Auto-save layout when nodes are moved
let layoutTimeout;
cy?.on('position', 'node', function() {
    clearTimeout(layoutTimeout);
    layoutTimeout = setTimeout(saveLayout, 1000);
});
</script>
{% endblock %}
