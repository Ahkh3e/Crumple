{% extends "base.html" %}

{% block title %}Device Types{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-6">
    <div class="mb-6 flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Device Types</h1>
            <p class="text-gray-600 mt-1">Manage device type definitions and their interfaces</p>
        </div>
        <button onclick="showNewDeviceTypeModal()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-all">
            <i class="fas fa-plus mr-2"></i>Add Device Type
        </button>
    </div>

    <!-- Device Types Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for device_type in device_types %}
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h3 class="text-lg font-medium text-gray-900">{{ device_type.name }}</h3>
                    <p class="text-sm text-gray-500">{{ device_type.manufacturer }}</p>
                </div>
                <div class="flex space-x-2">
                    <button onclick="editDeviceType('{{ device_type.id }}')" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteDeviceType('{{ device_type.id }}')" class="text-gray-400 hover:text-red-600">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="text-sm text-gray-600 space-y-2">
                <div class="flex justify-between">
                    <span>Model:</span>
                    <span class="font-medium">{{ device_type.model }}</span>
                </div>
                <div class="flex justify-between">
                    <span>Category:</span>
                    <span class="font-medium">{{ device_type.category }}</span>
                </div>
                <div class="flex justify-between">
                    <span>Interfaces:</span>
                    <span class="font-medium">{{ device_type.interfaces|length }}</span>
                </div>
            </div>
            <!-- Interface List -->
            <div class="mt-4 pt-4 border-t border-gray-200">
                <h4 class="text-sm font-medium text-gray-900 mb-2">Interfaces</h4>
                <div class="space-y-2">
                    {% for interface in device_type.interfaces %}
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-gray-600">{{ interface.name }}</span>
                        <span class="text-gray-500">{{ interface.type }} - {{ interface.speed }}G</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-span-3 text-center py-12 bg-white rounded-lg border border-gray-200">
            <i class="fas fa-cube text-4xl text-gray-400 mb-4"></i>
            <p class="text-gray-500">No device types defined. Create one to get started.</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- New Device Type Modal -->
<div id="device-type-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-[600px] shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Create Device Type</h3>
            <form id="device-type-form" class="space-y-4">
                <input type="hidden" name="id" id="device-type-id">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" name="name" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Category</label>
                        <select name="category" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="server">Server</option>
                            <option value="switch">Switch</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Manufacturer</label>
                        <input type="text" name="manufacturer" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Model</label>
                        <input type="text" name="model" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                </div>

                <!-- Interfaces Section -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium text-gray-700">Interfaces</label>
                        <button type="button" onclick="addInterface()"
                            class="text-sm text-blue-600 hover:text-blue-700">
                            <i class="fas fa-plus mr-1"></i>Add Interface
                        </button>
                    </div>
                    <div id="interfaces-list" class="space-y-2">
                        <!-- Interface fields will be added here -->
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-5">
                    <button type="button" onclick="hideDeviceTypeModal()"
                        class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200">
                        Cancel
                    </button>
                    <button type="submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Create
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% block scripts %}
<script>
let interfaceCounter = 0;

function addInterface() {
    const interfacesList = document.getElementById('interfaces-list');
    const interfaceDiv = document.createElement('div');
    interfaceDiv.className = 'p-3 border rounded-md';
    interfaceDiv.innerHTML = `
        <div class="grid grid-cols-3 gap-2">
            <div>
                <label class="block text-xs font-medium text-gray-700">Name</label>
                <input type="text" name="interfaces[${interfaceCounter}][name]" required
                    class="mt-1 block w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-700">Type</label>
                <select name="interfaces[${interfaceCounter}][type]" required
                    class="mt-1 block w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <option value="qsfp-dd">QSFP-DD</option>
                    <option value="qsfp28">QSFP28</option>
                    <option value="qsfp">QSFP+</option>
                    <option value="sfp">SFP+</option>
                    <option value="rj45">RJ45</option>
                    <option value="console">Console</option>
                    <option value="mgmt">Management</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-700">Speed (Gbps)</label>
                <input type="number" name="interfaces[${interfaceCounter}][speed]" required
                    class="mt-1 block w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>
        </div>
        <button type="button" class="mt-2 text-xs text-red-600 hover:text-red-800" onclick="this.parentElement.remove()">
            Remove Interface
        </button>
    `;
    interfacesList.appendChild(interfaceDiv);
    interfaceCounter++;
}

function showNewDeviceTypeModal() {
    document.getElementById('device-type-modal').classList.remove('hidden');
    document.getElementById('device-type-form').reset();
    document.getElementById('interfaces-list').innerHTML = '';
    document.getElementById('device-type-id').value = '';
    interfaceCounter = 0;
}

function hideDeviceTypeModal() {
    document.getElementById('device-type-modal').classList.add('hidden');
}

function editDeviceType(id) {
    // Fetch device type details and populate form
    fetch(`/api/v1/devices/types/${id}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('device-type-id').value = id;
            const form = document.getElementById('device-type-form');
            form.name.value = data.name;
            form.category.value = data.category;
            form.manufacturer.value = data.manufacturer;
            form.model.value = data.model;

            // Clear and repopulate interfaces
            document.getElementById('interfaces-list').innerHTML = '';
            data.interfaces.forEach(interface => {
                addInterface();
                const lastInterface = document.getElementById('interfaces-list').lastElementChild;
                lastInterface.querySelector('[name$="[name]"]').value = interface.name;
                lastInterface.querySelector('[name$="[type]"]').value = interface.type;
                lastInterface.querySelector('[name$="[speed]"]').value = interface.speed;
            });

            document.getElementById('device-type-modal').classList.remove('hidden');
        });
}

function deleteDeviceType(id) {
    if (confirm('Are you sure you want to delete this device type?')) {
        fetch(`/api/v1/devices/types/${id}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (response.ok) {
                showToast('Device type deleted successfully');
                window.location.reload();
            } else {
                showToast('Failed to delete device type', 'error');
            }
        })
        .catch(error => {
            showToast('Error deleting device type', 'error');
            console.error('Error:', error);
        });
    }
}

document.getElementById('device-type-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const data = {};
    
    // Convert FormData to structured object
    for (let [key, value] of formData.entries()) {
        if (key.startsWith('interfaces[')) {
            const match = key.match(/interfaces\[(\d+)\]\[(\w+)\]/);
            if (match) {
                const [, index, field] = match;
                if (!data.interfaces) data.interfaces = [];
                if (!data.interfaces[index]) data.interfaces[index] = {};
                data.interfaces[index][field] = value;
            }
        } else {
            data[key] = value;
        }
    }
    
    // Clean up interfaces array (remove empty slots)
    if (data.interfaces) {
        data.interfaces = data.interfaces.filter(Boolean);
    }

    const id = data.id;
    delete data.id;
    
    try {
        const response = await fetch(`/api/v1/devices/types/${id || ''}`, {
            method: id ? 'PUT' : 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            showToast(`Device type ${id ? 'updated' : 'created'} successfully`);
            hideDeviceTypeModal();
            window.location.reload();
        } else {
            showToast(`Failed to ${id ? 'update' : 'create'} device type`, 'error');
        }
    } catch (error) {
        showToast(`Error ${id ? 'updating' : 'creating'} device type`, 'error');
        console.error('Error:', error);
    }
});
</script>
{% endblock %}
{% endblock %}
