{% extends "base.html" %}

{% block title %}Devices{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-6">
    <div class="mb-6 flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Devices</h1>
            <p class="text-gray-600 mt-1">Manage network devices and their interfaces</p>
        </div>
        <button onclick="showNewDeviceModal()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-all">
            <i class="fas fa-plus mr-2"></i>Add Device
        </button>
    </div>

    <!-- Devices Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for device in devices %}
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h3 class="text-lg font-medium text-gray-900">{{ device.name }}</h3>
                    <p class="text-sm text-gray-500">{{ device.device_type.manufacturer }} {{ device.device_type.model }}</p>
                </div>
                <div class="flex space-x-2">
                    <button onclick="editDevice('{{ device.id }}')" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteDevice('{{ device.id }}')" class="text-gray-400 hover:text-red-600">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="text-sm text-gray-600 space-y-2">
                <div class="flex justify-between">
                    <span>Type:</span>
                    <span class="font-medium">{{ device.device_type.name }}</span>
                </div>
                <div class="flex justify-between">
                    <span>Category:</span>
                    <span class="font-medium">{{ device.device_type.category }}</span>
                </div>
                <div class="flex justify-between">
                    <span>Cluster:</span>
                    <span class="font-medium">{{ device.cluster.name if device.cluster else 'None' }}</span>
                </div>
            </div>
            <!-- Interface List -->
            <div class="mt-4 pt-4 border-t border-gray-200">
                <h4 class="text-sm font-medium text-gray-900 mb-2">Interfaces</h4>
                <div class="space-y-2">
                    {% for interface in device.interfaces %}
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-gray-600">{{ interface.name }}</span>
                        <span class="text-gray-500">
                            {% if interface.connected_to %}
                            Connected to {{ interface.connected_to.device.name }}:{{ interface.connected_to.name }}
                            {% else %}
                            Available
                            {% endif %}
                        </span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-span-3 text-center py-12 bg-white rounded-lg border border-gray-200">
            <i class="fas fa-hdd text-4xl text-gray-400 mb-4"></i>
            <p class="text-gray-500">No devices defined. Create one to get started.</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- New Device Modal -->
<div id="device-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-[600px] shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Create Device</h3>
            <form id="device-form" class="space-y-4">
                <input type="hidden" name="id" id="device-id">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" name="name" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Device Type</label>
                        <select name="device_type_id" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">Select a device type...</option>
                            {% for device_type in device_types %}
                            <option value="{{ device_type.id }}">{{ device_type.name }} ({{ device_type.manufacturer }} {{ device_type.model }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Cluster</label>
                        <select name="cluster_id"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">No cluster</option>
                            {% for cluster in clusters %}
                            <option value="{{ cluster.id }}">{{ cluster.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Serial Number</label>
                        <input type="text" name="serial_number"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-5">
                    <button type="button" onclick="hideDeviceModal()"
                        class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200">
                        Cancel
                    </button>
                    <button type="submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Create
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% block scripts %}
<script>
function showNewDeviceModal() {
    document.getElementById('device-modal').classList.remove('hidden');
    document.getElementById('device-form').reset();
    document.getElementById('device-id').value = '';
}

function hideDeviceModal() {
    document.getElementById('device-modal').classList.add('hidden');
}

function editDevice(id) {
    // Fetch device details and populate form
    fetch(`/api/v1/devices/${id}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('device-id').value = id;
            const form = document.getElementById('device-form');
            form.name.value = data.name;
            form.device_type_id.value = data.device_type_id;
            form.cluster_id.value = data.cluster_id || '';
            form.serial_number.value = data.serial_number || '';

            document.getElementById('device-modal').classList.remove('hidden');
        });
}

async function deleteDevice(id) {
    if (confirm('Are you sure you want to delete this device?')) {
        try {
            const response = await fetch(`/api/v1/devices/${id}`, {
                method: 'DELETE'
            });
            const result = await response.json();
            
            if (response.ok) {
                showToast('Device deleted successfully');
                window.location.reload();
            } else {
                showToast(result.detail || 'Failed to delete device', 'error');
            }
        } catch (error) {
            showToast('Error deleting device', 'error');
            console.error('Error:', error);
        }
    }
}

document.getElementById('device-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    // Clean up empty values
    if (!data.cluster_id) delete data.cluster_id;
    if (!data.serial_number) delete data.serial_number;

    const id = data.id;
    delete data.id;
    
    try {
        const response = await fetch(`/api/v1/devices/${id || ''}`, {
            method: id ? 'PUT' : 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (response.ok) {
            showToast(`Device ${id ? 'updated' : 'created'} successfully`);
            hideDeviceModal();
            window.location.reload();
        } else {
            showToast(result.detail || `Failed to ${id ? 'update' : 'create'} device`, 'error');
            
            // Highlight validation errors if any
            if (response.status === 400 && result.detail) {
                const form = document.getElementById('device-form');
                const fields = result.detail.match(/field '(\w+)'/g);
                if (fields) {
                    fields.forEach(field => {
                        const fieldName = field.match(/field '(\w+)'/)[1];
                        const input = form.querySelector(`[name="${fieldName}"]`);
                        if (input) {
                            input.classList.add('border-red-500');
                            input.addEventListener('input', function() {
                                this.classList.remove('border-red-500');
                            }, { once: true });
                        }
                    });
                }
            }
        }
    } catch (error) {
        console.error('Error:', error);
        showToast(`Error ${id ? 'updating' : 'creating'} device: ${error.message}`, 'error');
    }
});
</script>
{% endblock %}
{% endblock %}
